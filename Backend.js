!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Papyros=t():e.Papyros=t()}(self,(function(){return(()=>{var e={487:(e,t,r)=>{var n,o;self,e.exports=(n=r(137),o=r(375),(()=>{"use strict";var e={272:e=>{e.exports=o},746:e=>{e.exports=n}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{r.r(s),r.d(s,{InterruptError:()=>o,NoChannelError:()=>i,SyncClient:()=>a,syncExpose:()=>u});var e=r(746),t=r(272),n=function(e,t,r,n){return new(r||(r=Promise))((function(o,s){function i(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}u((n=n.apply(e,t||[])).next())}))};class o extends Error{constructor(){super(...arguments),this.type="InterruptError"}}class i extends Error{constructor(){super(...arguments),this.type="NoChannelError"}}class a{constructor(e,t){this.workerCreator=e,this.channel=t,this.state="idle",this._messageId="",this._start()}interrupt(){return n(this,void 0,void 0,(function*(){"idle"!==this.state&&(this._messageId?yield this._writeMessage({interrupted:!0}):this.interrupter?yield this.interrupter():(this.terminate(),this._start()))}))}call(e,...r){return n(this,void 0,void 0,(function*(){if("idle"!==this.state)throw new Error(`State is ${this.state}, not idle`);let n=!0;this.state="running";const o=this,s=(e,t)=>{n&&"init"!==t&&(o._messageId=e,"reading"===t?o.state="awaitingMessage":"slept"===t&&o._messageId===e&&(o._messageId=""))};this._interruptPromise=new Promise(((e,t)=>this._interruptRejector=t));try{return yield Promise.race([e(this.channel,t.proxy(s),...r),this._interruptPromise])}finally{n=!1,this._reset()}}))}writeMessage(e){return n(this,void 0,void 0,(function*(){if("awaitingMessage"!==this.state)throw new Error("Not waiting for message");yield this._writeMessage({message:e})}))}terminate(){var e;null===(e=this._interruptRejector)||void 0===e||e.call(this,new o("Worker terminated")),this.workerProxy[t.releaseProxy](),this.worker.terminate(),delete this.workerProxy,delete this.worker}_writeMessage(t){return n(this,void 0,void 0,(function*(){const{_messageId:r}=this;if(!r)throw new Error("No messageId set");this.state="running",this._messageId="",yield(0,e.writeMessage)(this.channel,t,r)}))}_start(){this._reset(),this.worker=this.workerCreator(),this.workerProxy=t.wrap(this.worker)}_reset(){this.state="idle",this._messageId="",delete this._interruptPromise,delete this._interruptRejector}}function u(t){return function(r,s,...a){return n(this,void 0,void 0,(function*(){function n(t,n){if(!r)throw new i;const a=(0,e.uuidv4)();s(a,t);const u=(0,e.readMessage)(r,a,n);if(u){const{message:e,interrupted:t}=u;if(t)throw new o;return e}"sleeping"===t&&s(a,"slept")}return yield s("","init"),t({channel:r,readMessage:()=>n("reading"),syncSleep(e){e>0&&n("sleeping",{timeout:e})}},...a)}))}}})(),s})())},137:e=>{self,e.exports=(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{serviceWorkerFetchListener:()=>s,asyncSleep:()=>i,ServiceWorkerError:()=>a,writeMessageAtomics:()=>u,writeMessageServiceWorker:()=>c,writeMessage:()=>l,makeChannel:()=>d,makeAtomicsChannel:()=>p,makeServiceWorkerChannel:()=>f,readMessage:()=>h,syncSleep:()=>m,uuidv4:()=>v});var r=function(e,t,r,n){return new(r||(r=Promise))((function(o,s){function i(e){try{u(n.next(e))}catch(e){s(e)}}function a(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}u((n=n.apply(e,t||[])).next())}))};const n="__SyncMessageServiceWorkerInput__",o="__sync-message-v2__";function s(){const e={},t={};return s=>{const{url:i}=s.request;return!!i.includes(n)&&(s.respondWith(function(){return r(this,void 0,void 0,(function*(){function r(e){const t={message:e,version:o};return new Response(JSON.stringify(t),{status:200})}if(i.endsWith("/read")){const{messageId:n,timeout:o}=yield s.request.json(),i=e[n];return i?(delete e[n],r(i)):yield new Promise((e=>{t[n]=e,setTimeout((function(){delete t[n],e(new Response("",{status:408}))}),o)}))}if(i.endsWith("/write")){const{message:n,messageId:o}=yield s.request.json(),i=t[o];return i?(i(r(n)),delete t[o]):e[o]=n,r({early:!i})}if(i.endsWith("/version"))return new Response(o,{status:200})}))}()),!0)}}function i(e){return new Promise((t=>setTimeout(t,e)))}class a extends Error{constructor(e,t){super(`Received status ${t} from ${e}. Ensure the service worker is registered and active.`),this.url=e,this.status=t,this.type="ServiceWorkerError",Object.setPrototypeOf(this,a.prototype)}}function u(e,t){const r=(new TextEncoder).encode(JSON.stringify(t)),{data:n,meta:o}=e;if(r.length>n.length)throw new Error("Message is too big, increase bufferSize when making channel.");n.set(r,0),Atomics.store(o,0,r.length),Atomics.store(o,1,1),Atomics.notify(o,1)}function c(e,t,n){return r(this,void 0,void 0,(function*(){yield navigator.serviceWorker.ready;const r=e.baseUrl+"/write",s=Date.now();for(;;){const u={message:t,messageId:n},c=yield fetch(r,{method:"POST",body:JSON.stringify(u)});if(200===c.status&&(yield c.json()).version===o)return;if(!(Date.now()-s<e.timeout))throw new a(r,c.status);yield i(100)}}))}function l(e,t,n){return r(this,void 0,void 0,(function*(){"atomics"===e.type?u(e,t):yield c(e,t,n)}))}function d(e={}){return"undefined"!=typeof SharedArrayBuffer?p(e.atomics):"serviceWorker"in navigator?f(e.serviceWorker):null}function p({bufferSize:e}={}){return{type:"atomics",data:new Uint8Array(new SharedArrayBuffer(e||131072)),meta:new Int32Array(new SharedArrayBuffer(2*Int32Array.BYTES_PER_ELEMENT))}}function f(e={}){return{type:"serviceWorker",baseUrl:(e.scope||"/")+n,timeout:e.timeout||5e3}}function y(e,t){return e>0?+e:t}function h(e,t,{checkInterrupt:r,checkTimeout:n,timeout:s}={}){const i=performance.now();n=y(n,r?100:5e3);const u=y(s,Number.POSITIVE_INFINITY);let c;if("atomics"===e.type){const{data:t,meta:r}=e;c=()=>{if("timed-out"===Atomics.wait(r,1,0,n))return null;{const e=Atomics.exchange(r,0,0),n=t.slice(0,e);Atomics.store(r,1,0);const o=(new TextDecoder).decode(n);return JSON.parse(o)}}}else c=()=>{const r=new XMLHttpRequest,s=e.baseUrl+"/read";r.open("POST",s,!1);const u={messageId:t,timeout:n};r.send(JSON.stringify(u));const{status:c}=r;if(408===c)return null;if(200===c){const e=JSON.parse(r.responseText);return e.version!==o?null:e.message}if(performance.now()-i<e.timeout)return null;throw new a(s,c)};for(;;){const e=u-(performance.now()-i);if(e<=0)return null;n=Math.min(n,e);const t=c();if(null!==t)return t;if(null==r?void 0:r())return null}}function m(e,t){if(e=y(e,0))if("undefined"!=typeof SharedArrayBuffer){const t=new Int32Array(new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT));t[0]=0,Atomics.wait(t,0,0,e)}else h(t,`sleep ${e} ${v()}`,{timeout:e})}let v;return v="randomUUID"in crypto?function(){return crypto.randomUUID()}:function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(e=>{const t=Number(e);return(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)}))},t})()},358:(e,t,r)=>{"use strict";var n;r.d(t,{BackendEventType:()=>n}),function(e){e.Start="start",e.End="end",e.Input="input",e.Output="output",e.Sleep="sleep",e.Error="error",e.Interrupt="interrupt"}(n||(n={}));n.Start,n.End,n.Input,n.Output,n.Sleep,n.Error,n.Interrupt},155:(e,t,r)=>{"use strict";r.d(t,{LogType:()=>n,papyrosLog:()=>i});var n,o=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,s=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return i},s=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,s=t.length;o<s;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))};!function(e){e[e.Debug=0]="Debug",e[e.Error=1]="Error",e[e.Important=2]="Important"}(n||(n={}));function i(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];var i=e!==n.Debug;i&&(e===n.Error?console.error.apply(console,s([],o(t),!1)):console.log.apply(console,s([],o(t),!1)))}},375:(e,t,r)=>{"use strict";r.r(t),r.d(t,{createEndpoint:()=>o,expose:()=>c,proxy:()=>v,proxyMarker:()=>n,releaseProxy:()=>s,transfer:()=>m,transferHandlers:()=>u,windowEndpoint:()=>g,wrap:()=>d});const n=Symbol("Comlink.proxy"),o=Symbol("Comlink.endpoint"),s=Symbol("Comlink.releaseProxy"),i=Symbol("Comlink.thrown"),a=e=>"object"==typeof e&&null!==e||"function"==typeof e,u=new Map([["proxy",{canHandle:e=>a(e)&&e[n],serialize(e){const{port1:t,port2:r}=new MessageChannel;return c(e,t),[r,[r]]},deserialize:e=>(e.start(),d(e))}],["throw",{canHandle:e=>a(e)&&i in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function c(e,t=self){t.addEventListener("message",(function r(n){if(!n||!n.data)return;const{id:o,type:s,path:a}=Object.assign({path:[]},n.data),u=(n.data.argumentList||[]).map(E);let d;try{const t=a.slice(0,-1).reduce(((e,t)=>e[t]),e),r=a.reduce(((e,t)=>e[t]),e);switch(s){case"GET":d=r;break;case"SET":t[a.slice(-1)[0]]=E(n.data.value),d=!0;break;case"APPLY":d=r.apply(t,u);break;case"CONSTRUCT":d=v(new r(...u));break;case"ENDPOINT":{const{port1:t,port2:r}=new MessageChannel;c(e,r),d=m(t,[t])}break;case"RELEASE":d=void 0;break;default:return}}catch(e){d={value:e,[i]:0}}Promise.resolve(d).catch((e=>({value:e,[i]:0}))).then((e=>{const[n,i]=w(e);t.postMessage(Object.assign(Object.assign({},n),{id:o}),i),"RELEASE"===s&&(t.removeEventListener("message",r),l(t))}))})),t.start&&t.start()}function l(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function d(e,t){return f(e,[],t)}function p(e){if(e)throw new Error("Proxy has been released and is not useable")}function f(e,t=[],r=function(){}){let n=!1;const i=new Proxy(r,{get(r,o){if(p(n),o===s)return()=>S(e,{type:"RELEASE",path:t.map((e=>e.toString()))}).then((()=>{l(e),n=!0}));if("then"===o){if(0===t.length)return{then:()=>i};const r=S(e,{type:"GET",path:t.map((e=>e.toString()))}).then(E);return r.then.bind(r)}return f(e,[...t,o])},set(r,o,s){p(n);const[i,a]=w(s);return S(e,{type:"SET",path:[...t,o].map((e=>e.toString())),value:i},a).then(E)},apply(r,s,i){p(n);const a=t[t.length-1];if(a===o)return S(e,{type:"ENDPOINT"}).then(E);if("bind"===a)return f(e,t.slice(0,-1));const[u,c]=y(i);return S(e,{type:"APPLY",path:t.map((e=>e.toString())),argumentList:u},c).then(E)},construct(r,o){p(n);const[s,i]=y(o);return S(e,{type:"CONSTRUCT",path:t.map((e=>e.toString())),argumentList:s},i).then(E)}});return i}function y(e){const t=e.map(w);return[t.map((e=>e[0])),(r=t.map((e=>e[1])),Array.prototype.concat.apply([],r))];var r}const h=new WeakMap;function m(e,t){return h.set(e,t),e}function v(e){return Object.assign(e,{[n]:!0})}function g(e,t=self,r="*"){return{postMessage:(t,n)=>e.postMessage(t,r,n),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function w(e){for(const[t,r]of u)if(r.canHandle(e)){const[n,o]=r.serialize(e);return[{type:"HANDLER",name:t,value:n},o]}return[{type:"RAW",value:e},h.get(e)||[]]}function E(e){switch(e.type){case"HANDLER":return u.get(e.name).deserialize(e.value);case"RAW":return e.value}}function S(e,t,r){return new Promise((n=>{const o=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function t(r){r.data&&r.data.id&&r.data.id===o&&(e.removeEventListener("message",t),n(r.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:o},t),r)}))}}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{"use strict";r.r(n),r.d(n,{Backend:()=>i});var e=r(358),t=r(155),o=r(487),s=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,s=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return i},i=function(){function r(e){void 0===e&&(e=["runCode"]),this.syncExtras={},this.onEvent=function(){},this.exposeMethods(Array.from(e))}return r.prototype.syncExpose=function(){return o.syncExpose},r.prototype.exposeMethods=function(e){var t=this;e.forEach((function(e){var r=t[e];t[e]=t.syncExpose()(r.bind(t))}))},r.prototype.launch=function(t){var r=this;return this.onEvent=function(n){return t(n),n.type===e.BackendEventType.Sleep?r.syncExtras.syncSleep(n.data):n.type===e.BackendEventType.Input?r.syncExtras.readMessage():void 0},Promise.resolve()},r.convertCompletionContext=function(e,r){void 0===r&&(r=/\w*(\.)?/);var n=s(e.state.selection.ranges.map((function(t){var r=e.state.doc.lineAt(t.head);return[r.number,t.head-r.from]}))[0],2),o=n[0],i=n[1],a=e.matchBefore(r),u={explicit:e.explicit,before:a,pos:e.pos,column:i,line:o,text:e.state.doc.toString()};return(0,t.papyrosLog)(t.LogType.Debug,"Worker completion context:",u),u},r}()})(),n})()}));