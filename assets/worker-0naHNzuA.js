/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const proxyMarker=Symbol("Comlink.proxy"),createEndpoint=Symbol("Comlink.endpoint"),releaseProxy=Symbol("Comlink.releaseProxy"),finalizer=Symbol("Comlink.finalizer"),throwMarker=Symbol("Comlink.thrown"),isObject=e=>typeof e=="object"&&e!==null||typeof e=="function",proxyTransferHandler={canHandle:e=>isObject(e)&&e[proxyMarker],serialize(e){const{port1:r,port2:t}=new MessageChannel;return expose(e,r),[t,[t]]},deserialize(e){return e.start(),wrap(e)}},throwTransferHandler={canHandle:e=>isObject(e)&&throwMarker in e,serialize({value:e}){let r;return e instanceof Error?r={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:r={isError:!1,value:e},[r,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},transferHandlers=new Map([["proxy",proxyTransferHandler],["throw",throwTransferHandler]]);function isAllowedOrigin(e,r){for(const t of e)if(r===t||t==="*"||t instanceof RegExp&&t.test(r))return!0;return!1}function expose(e,r=globalThis,t=["*"]){r.addEventListener("message",function i(a){if(!a||!a.data)return;if(!isAllowedOrigin(t,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:p,type:f,path:w}=Object.assign({path:[]},a.data),u=(a.data.argumentList||[]).map(fromWireValue);let c;try{const l=w.slice(0,-1).reduce((m,O)=>m[O],e),E=w.reduce((m,O)=>m[O],e);switch(f){case"GET":c=E;break;case"SET":l[w.slice(-1)[0]]=fromWireValue(a.data.value),c=!0;break;case"APPLY":c=E.apply(l,u);break;case"CONSTRUCT":{const m=new E(...u);c=proxy(m)}break;case"ENDPOINT":{const{port1:m,port2:O}=new MessageChannel;expose(e,O),c=transfer(m,[m])}break;case"RELEASE":c=void 0;break;default:return}}catch(l){c={value:l,[throwMarker]:0}}Promise.resolve(c).catch(l=>({value:l,[throwMarker]:0})).then(l=>{const[E,m]=toWireValue(l);r.postMessage(Object.assign(Object.assign({},E),{id:p}),m),f==="RELEASE"&&(r.removeEventListener("message",i),closeEndPoint(r),finalizer in e&&typeof e[finalizer]=="function"&&e[finalizer]())}).catch(l=>{const[E,m]=toWireValue({value:new TypeError("Unserializable return value"),[throwMarker]:0});r.postMessage(Object.assign(Object.assign({},E),{id:p}),m)})}),r.start&&r.start()}function isMessagePort(e){return e.constructor.name==="MessagePort"}function closeEndPoint(e){isMessagePort(e)&&e.close()}function wrap(e,r){const t=new Map;return e.addEventListener("message",function(a){const{data:p}=a;if(!p||!p.id)return;const f=t.get(p.id);if(f)try{f(p)}finally{t.delete(p.id)}}),createProxy(e,t,[],r)}function throwIfProxyReleased(e){if(e)throw new Error("Proxy has been released and is not useable")}function releaseEndpoint(e){return requestResponseMessage(e,new Map,{type:"RELEASE"}).then(()=>{closeEndPoint(e)})}const proxyCounter=new WeakMap,proxyFinalizers="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const r=(proxyCounter.get(e)||0)-1;proxyCounter.set(e,r),r===0&&releaseEndpoint(e)});function registerProxy(e,r){const t=(proxyCounter.get(r)||0)+1;proxyCounter.set(r,t),proxyFinalizers&&proxyFinalizers.register(e,r,e)}function unregisterProxy(e){proxyFinalizers&&proxyFinalizers.unregister(e)}function createProxy(e,r,t=[],i=function(){}){let a=!1;const p=new Proxy(i,{get(f,w){if(throwIfProxyReleased(a),w===releaseProxy)return()=>{unregisterProxy(p),releaseEndpoint(e),r.clear(),a=!0};if(w==="then"){if(t.length===0)return{then:()=>p};const u=requestResponseMessage(e,r,{type:"GET",path:t.map(c=>c.toString())}).then(fromWireValue);return u.then.bind(u)}return createProxy(e,r,[...t,w])},set(f,w,u){throwIfProxyReleased(a);const[c,l]=toWireValue(u);return requestResponseMessage(e,r,{type:"SET",path:[...t,w].map(E=>E.toString()),value:c},l).then(fromWireValue)},apply(f,w,u){throwIfProxyReleased(a);const c=t[t.length-1];if(c===createEndpoint)return requestResponseMessage(e,r,{type:"ENDPOINT"}).then(fromWireValue);if(c==="bind")return createProxy(e,r,t.slice(0,-1));const[l,E]=processArguments(u);return requestResponseMessage(e,r,{type:"APPLY",path:t.map(m=>m.toString()),argumentList:l},E).then(fromWireValue)},construct(f,w){throwIfProxyReleased(a);const[u,c]=processArguments(w);return requestResponseMessage(e,r,{type:"CONSTRUCT",path:t.map(l=>l.toString()),argumentList:u},c).then(fromWireValue)}});return registerProxy(p,e),p}function myFlat(e){return Array.prototype.concat.apply([],e)}function processArguments(e){const r=e.map(toWireValue);return[r.map(t=>t[0]),myFlat(r.map(t=>t[1]))]}const transferCache=new WeakMap;function transfer(e,r){return transferCache.set(e,r),e}function proxy(e){return Object.assign(e,{[proxyMarker]:!0})}function windowEndpoint(e,r=globalThis,t="*"){return{postMessage:(i,a)=>e.postMessage(i,t,a),addEventListener:r.addEventListener.bind(r),removeEventListener:r.removeEventListener.bind(r)}}function toWireValue(e){for(const[r,t]of transferHandlers)if(t.canHandle(e)){const[i,a]=t.serialize(e);return[{type:"HANDLER",name:r,value:i},a]}return[{type:"RAW",value:e},transferCache.get(e)||[]]}function fromWireValue(e){switch(e.type){case"HANDLER":return transferHandlers.get(e.name).deserialize(e.value);case"RAW":return e.value}}function requestResponseMessage(e,r,t,i){return new Promise(a=>{const p=generateUUID();r.set(p,a),e.start&&e.start(),e.postMessage(Object.assign({id:p},t),i)})}function generateUUID(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var comlink=Object.freeze({__proto__:null,createEndpoint,expose,finalizer,proxy,proxyMarker,releaseProxy,transfer,transferHandlers,windowEndpoint,wrap}),BackendEventType=(e=>(e.Start="start",e.End="end",e.Input="input",e.Output="output",e.Sleep="sleep",e.Error="error",e.Interrupt="interrupt",e.Loading="loading",e.Frame="frame",e.FrameChange="frame-change",e.Stop="stop",e))(BackendEventType||{});function getAugmentedNamespace(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var r=e.default;if(typeof r=="function"){var t=function i(){var a=!1;try{a=this instanceof i}catch{}return a?Reflect.construct(r,arguments,this.constructor):r.apply(this,arguments)};t.prototype=r.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(e).forEach(function(i){var a=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,a.get?a:{enumerable:!0,get:function(){return e[i]}})}),t}var dist$1={exports:{}},dist={exports:{}},hasRequiredDist$1;function requireDist$1(){return hasRequiredDist$1||(hasRequiredDist$1=1,(function(e,r){(function(t,i){e.exports=i()})(self,(function(){return(()=>{var t={d:(n,s)=>{for(var o in s)t.o(s,o)&&!t.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:s[o]})},o:(n,s)=>Object.prototype.hasOwnProperty.call(n,s),r:n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})}},i={};t.r(i),t.d(i,{isServiceWorkerRequest:()=>w,serviceWorkerFetchListener:()=>u,asyncSleep:()=>c,ServiceWorkerError:()=>l,writeMessageAtomics:()=>E,writeMessageServiceWorker:()=>m,writeMessage:()=>O,makeChannel:()=>A,makeAtomicsChannel:()=>q,makeServiceWorkerChannel:()=>M,readMessage:()=>v,syncSleep:()=>_,uuidv4:()=>T});var a=function(n,s,o,h){return new(o||(o=Promise))((function(y,d){function x(b){try{k(h.next(b))}catch(P){d(P)}}function S(b){try{k(h.throw(b))}catch(P){d(P)}}function k(b){var P;b.done?y(b.value):(P=b.value,P instanceof o?P:new o((function(R){R(P)}))).then(x,S)}k((h=h.apply(n,[])).next())}))};const p="__SyncMessageServiceWorkerInput__",f="__sync-message-v2__";function w(n){return typeof n!="string"&&(n=n.request.url),n.includes(p)}function u(){const n={},s={};return o=>{const{url:h}=o.request;return!!w(h)&&(o.respondWith((function(){return a(this,void 0,void 0,(function*(){function y(d){const x={message:d,version:f};return new Response(JSON.stringify(x),{status:200})}if(h.endsWith("/read")){const{messageId:d,timeout:x}=yield o.request.json();if(d in n){const S=n[d];return delete n[d],y(S)}return yield new Promise((S=>{s[d]=S,setTimeout((function(){delete s[d],S(new Response("",{status:408}))}),x)}))}if(h.endsWith("/write")){const{message:d,messageId:x}=yield o.request.json(),S=s[x];return S?(S(y(d)),delete s[x]):n[x]=d,y({early:!S})}if(h.endsWith("/version"))return new Response(f,{status:200})}))})()),!0)}}function c(n){return new Promise((s=>setTimeout(s,n)))}class l extends Error{constructor(s,o){super(`Received status ${o} from ${s}. Ensure the service worker is registered and active.`),this.url=s,this.status=o,this.type="ServiceWorkerError",Object.setPrototypeOf(this,l.prototype)}}function E(n,s){const o=new TextEncoder().encode(JSON.stringify(s)),{data:h,meta:y}=n;if(o.length>h.length)throw new Error("Message is too big, increase bufferSize when making channel.");h.set(o,0),Atomics.store(y,0,o.length),Atomics.store(y,1,1),Atomics.notify(y,1)}function m(n,s,o){return a(this,void 0,void 0,(function*(){yield navigator.serviceWorker.ready;const h=n.baseUrl+"/write",y=Date.now();for(;;){const d={message:s,messageId:o},x=yield fetch(h,{method:"POST",body:JSON.stringify(d)});if(x.status===200&&(yield x.json()).version===f)return;if(!(Date.now()-y<n.timeout))throw new l(h,x.status);yield c(100)}}))}function O(n,s,o){return a(this,void 0,void 0,(function*(){n.type==="atomics"?E(n,s):yield m(n,s,o)}))}function A(n={}){return typeof SharedArrayBuffer<"u"?q(n.atomics):"serviceWorker"in navigator?M(n.serviceWorker):null}function q({bufferSize:n}={}){return{type:"atomics",data:new Uint8Array(new SharedArrayBuffer(n||131072)),meta:new Int32Array(new SharedArrayBuffer(2*Int32Array.BYTES_PER_ELEMENT))}}function M(n={}){return{type:"serviceWorker",baseUrl:(n.scope||"/")+p,timeout:n.timeout||5e3}}function g(n,s){return n>0?+n:s}function v(n,s,{checkInterrupt:o,checkTimeout:h,timeout:y}={}){const d=performance.now();h=g(h,o?100:5e3);const x=g(y,Number.POSITIVE_INFINITY);let S;if(n.type==="atomics"){const{data:k,meta:b}=n;S=()=>{if(Atomics.wait(b,1,0,h)==="timed-out")return null;{const P=Atomics.exchange(b,0,0),R=k.slice(0,P);Atomics.store(b,1,0);const I=new TextDecoder().decode(R);return JSON.parse(I)}}}else S=()=>{const k=new XMLHttpRequest,b=n.baseUrl+"/read";k.open("POST",b,!1);const P={messageId:s,timeout:h};k.send(JSON.stringify(P));const{status:R}=k;if(R===408)return null;if(R===200){const I=JSON.parse(k.responseText);return I.version!==f?null:I.message}if(performance.now()-d<n.timeout)return null;throw new l(b,R)};for(;;){const k=x-(performance.now()-d);if(k<=0)return null;h=Math.min(h,k);const b=S();if(b!==null)return b;if(o?.())return null}}function _(n,s){if(n=g(n,0))if(typeof SharedArrayBuffer<"u"){const o=new Int32Array(new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT));o[0]=0,Atomics.wait(o,0,0,n)}else v(s,`sleep ${n} ${T()}`,{timeout:n})}let T;return T="randomUUID"in crypto?function(){return crypto.randomUUID()}:function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(n=>{const s=Number(n);return(s^crypto.getRandomValues(new Uint8Array(1))[0]&15>>s/4).toString(16)}))},i})()}))})(dist)),dist.exports}var require$$1=getAugmentedNamespace(comlink),hasRequiredDist;function requireDist(){return hasRequiredDist||(hasRequiredDist=1,(function(e,r){(function(t,i){e.exports=i(requireDist$1(),require$$1)})(self,(function(t,i){return(()=>{var a={272:u=>{u.exports=i},746:u=>{u.exports=t}},p={};function f(u){var c=p[u];if(c!==void 0)return c.exports;var l=p[u]={exports:{}};return a[u](l,l.exports,f),l.exports}f.n=u=>{var c=u&&u.__esModule?()=>u.default:()=>u;return f.d(c,{a:c}),c},f.d=(u,c)=>{for(var l in c)f.o(c,l)&&!f.o(u,l)&&Object.defineProperty(u,l,{enumerable:!0,get:c[l]})},f.o=(u,c)=>Object.prototype.hasOwnProperty.call(u,c),f.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})};var w={};return(()=>{f.r(w),f.d(w,{InterruptError:()=>E,NoChannelError:()=>m,SyncClient:()=>O,syncExpose:()=>A});var u=f(746),c=f(272),l=function(M,g,v,_){return new(v||(v=Promise))((function(T,n){function s(y){try{h(_.next(y))}catch(d){n(d)}}function o(y){try{h(_.throw(y))}catch(d){n(d)}}function h(y){var d;y.done?T(y.value):(d=y.value,d instanceof v?d:new v((function(x){x(d)}))).then(s,o)}h((_=_.apply(M,[])).next())}))};class E extends Error{constructor(){super(...arguments),this.type="InterruptError",this.name=this.type}}class m extends Error{constructor(){super(...arguments),this.type="NoChannelError",this.name=this.type}}class O{constructor(g,v){this.workerCreator=g,this.channel=v,this.state="idle",this._messageIdBase="",this._messageIdSeq=0,this._start()}interrupt(){return l(this,void 0,void 0,(function*(){this.state!=="idle"&&(this.state!=="awaitingMessage"&&this.state!=="sleeping"?this.interrupter?yield this.interrupter():(this.terminate(),this._start()):yield this._writeMessage({interrupted:!0}))}))}call(g,...v){return l(this,void 0,void 0,(function*(){if(this.state!=="idle")throw new Error(`State is ${this.state}, not idle`);let _=!0;this.state="running",this._messageIdBase=(0,u.uuidv4)(),this._messageIdSeq=0;const T=n=>{var s;_&&n!=="init"&&(n==="reading"?(this.state="awaitingMessage",this._messageIdSeq++,(s=this._awaitingMessageResolve)===null||s===void 0||s.call(this)):n==="sleeping"?(this.state="sleeping",this._messageIdSeq++):n==="slept"&&(this.state="running"))};this._interruptPromise=new Promise(((n,s)=>this._interruptRejector=s));try{return yield Promise.race([g(this.channel,c.proxy(T),this._messageIdBase,...v),this._interruptPromise])}finally{_=!1,this._reset()}}))}writeMessage(g){return l(this,void 0,void 0,(function*(){if(this.state==="idle"||!this._messageIdBase)throw new Error("No active call to send a message to.");if(this.state!=="awaitingMessage"){if(this._awaitingMessageResolve)throw new Error("Not waiting for message, and another write is already queued.");yield new Promise((v=>{this._awaitingMessageResolve=v})),delete this._awaitingMessageResolve}yield this._writeMessage({message:g})}))}terminate(){var g;(g=this._interruptRejector)===null||g===void 0||g.call(this,new E("Worker terminated")),this.workerProxy[c.releaseProxy](),this.worker.terminate(),delete this.workerProxy,delete this.worker}_writeMessage(g){return l(this,void 0,void 0,(function*(){this.state="running";const v=q(this._messageIdBase,this._messageIdSeq);yield(0,u.writeMessage)(this.channel,g,v)}))}_start(){this._reset(),this.worker=this.workerCreator(),this.workerProxy=c.wrap(this.worker)}_reset(){this.state="idle",delete this._interruptPromise,delete this._interruptRejector,delete this._awaitingMessageResolve,delete this._messageIdBase}}function A(M){return function(g,v,_,...T){return l(this,void 0,void 0,(function*(){yield v("init");let n=0;function s(o,h){if(!g)throw new m;v(o);const y=q(_,++n),d=(0,u.readMessage)(g,y,h);if(d){const{message:x,interrupted:S}=d;if(S)throw new E;return x}o==="sleeping"&&v("slept")}return M({channel:g,readMessage:()=>s("reading"),syncSleep(o){o>0&&s("sleeping",{timeout:o})}},...T)}))}}function q(M,g){return`${M}-${g}`}})(),w})()}))})(dist$1)),dist$1.exports}var distExports=requireDist();class BackendEventQueue{constructor(r,t=100){this.callback=r,this.flushTime=t,this.queue=[],this.lastFlushTime=new Date().getTime(),this.decoder=new TextDecoder}put(r,t,i){let a="";typeof t=="number"?a=t.toString():typeof t!="string"?a=this.decoder.decode(t):a=t;let p={},f="text/plain";i&&(typeof i=="string"?f=i:(f=i.contentType,delete i.contentType,p=i)),this.queue.length===0||!f.startsWith("text")||this.queue[this.queue.length-1].type!==r||this.queue[this.queue.length-1].contentType!==f?this.queue.push({type:r,data:a,contentType:f,...p}):this.queue[this.queue.length-1].data+=a,this.shouldFlush()&&this.flush()}shouldFlush(){return this.queue.length>1||new Date().getTime()-this.lastFlushTime>this.flushTime}reset(){this.queue=[],this.lastFlushTime=new Date().getTime()}flush(){this.queue.forEach(r=>{this.callback(r)}),this.queue=[],this.lastFlushTime=new Date().getTime()}setCallback(r){this.callback=r}}class Backend{constructor(){this.extras={},this.onEvent=()=>{},this.runCode=this.syncExpose()(this.runCode.bind(this)),this.queue={}}syncExpose(){return distExports.syncExpose}async launch(r){return this.onEvent=t=>{if(r(t),t.type===BackendEventType.Sleep)return this.extras.syncSleep(t.data);if(t.type===BackendEventType.Input)return this.extras.readMessage()},this.queue=new BackendEventQueue(this.onEvent.bind(this)),Promise.resolve()}runModes(r){return[]}provideFiles(r,t){return Promise.resolve()}}class JavaScriptWorker extends Backend{static stringify(...e){return e.map(t=>{if(Array.isArray(t))return JSON.stringify(t);if(typeof t=="string")return t;if(typeof t=="number")return t+"";if(typeof t=="object"&&"toString"in t){let i=t.toString();return i==="[object Object]"&&(i=JSON.stringify(t)),i}else return JSON.stringify(e)}).join(" ")}prompt(e=""){return this.onEvent({type:BackendEventType.Input,data:e,contentType:"text/plain"})}consoleLog(...e){this.queue.put(BackendEventType.Output,JavaScriptWorker.stringify(...e)+`
`,"text/plain")}consoleError(...e){this.queue.put(BackendEventType.Error,JavaScriptWorker.stringify(...e)+`
`,"text/plain")}static completeProperties(e,r){const t=Object.keys(r).map(i=>({label:i,type:typeof r[i]=="function"?"function":"variable"}));return{from:e,options:t,validFor:/^[\w$]*$/}}async runCode(extras,code){this.extras=extras,this.queue.reset();const oldContent={"console.log":console.log,"console.error":console.error},newContext={prompt:this.prompt.bind(this),"console.log":this.consoleLog.bind(this),"console.error":this.consoleError.bind(this)};new Function("ctx",Object.keys(newContext).map(e=>`${e} = ctx['${e}'];`).join(`
`))(newContext);let result=null;try{this.onEvent({type:BackendEventType.Start,contentType:"text/plain",data:"RunCode"}),result=await eval(code)}catch(e){Error.captureStackTrace(e),result=await this.onEvent({type:BackendEventType.Error,contentType:"application/json",data:{name:e.constructor.name,what:e.message,traceback:e.stack}})}finally{new Function("ctx",Object.keys(oldContent).map(e=>`${e} = ctx['${e}'];`).join(`
`))(oldContent),this.queue.flush(),this.onEvent({type:BackendEventType.End,contentType:"text/plain",data:"CodeFinished"})}return result}async lintCode(){return Promise.resolve([])}}const worker=new JavaScriptWorker;expose(worker);
