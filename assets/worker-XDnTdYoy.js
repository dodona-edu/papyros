/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const proxyMarker=Symbol("Comlink.proxy"),createEndpoint=Symbol("Comlink.endpoint"),releaseProxy=Symbol("Comlink.releaseProxy"),finalizer=Symbol("Comlink.finalizer"),throwMarker=Symbol("Comlink.thrown"),isObject=e=>typeof e=="object"&&e!==null||typeof e=="function",proxyTransferHandler={canHandle:e=>isObject(e)&&e[proxyMarker],serialize(e){const{port1:t,port2:r}=new MessageChannel;return expose(e,t),[r,[r]]},deserialize(e){return e.start(),wrap(e)}},throwTransferHandler={canHandle:e=>isObject(e)&&throwMarker in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},transferHandlers=new Map([["proxy",proxyTransferHandler],["throw",throwTransferHandler]]);function isAllowedOrigin(e,t){for(const r of e)if(t===r||r==="*"||r instanceof RegExp&&r.test(t))return!0;return!1}function expose(e,t=globalThis,r=["*"]){t.addEventListener("message",function s(o){if(!o||!o.data)return;if(!isAllowedOrigin(r,o.origin)){console.warn(`Invalid origin '${o.origin}' for comlink proxy`);return}const{id:p,type:f,path:w}=Object.assign({path:[]},o.data),u=(o.data.argumentList||[]).map(fromWireValue);let c;try{const l=w.slice(0,-1).reduce((m,_)=>m[_],e),E=w.reduce((m,_)=>m[_],e);switch(f){case"GET":c=E;break;case"SET":l[w.slice(-1)[0]]=fromWireValue(o.data.value),c=!0;break;case"APPLY":c=E.apply(l,u);break;case"CONSTRUCT":{const m=new E(...u);c=proxy(m)}break;case"ENDPOINT":{const{port1:m,port2:_}=new MessageChannel;expose(e,_),c=transfer(m,[m])}break;case"RELEASE":c=void 0;break;default:return}}catch(l){c={value:l,[throwMarker]:0}}Promise.resolve(c).catch(l=>({value:l,[throwMarker]:0})).then(l=>{const[E,m]=toWireValue(l);t.postMessage(Object.assign(Object.assign({},E),{id:p}),m),f==="RELEASE"&&(t.removeEventListener("message",s),closeEndPoint(t),finalizer in e&&typeof e[finalizer]=="function"&&e[finalizer]())}).catch(l=>{const[E,m]=toWireValue({value:new TypeError("Unserializable return value"),[throwMarker]:0});t.postMessage(Object.assign(Object.assign({},E),{id:p}),m)})}),t.start&&t.start()}function isMessagePort(e){return e.constructor.name==="MessagePort"}function closeEndPoint(e){isMessagePort(e)&&e.close()}function wrap(e,t){const r=new Map;return e.addEventListener("message",function(o){const{data:p}=o;if(!p||!p.id)return;const f=r.get(p.id);if(f)try{f(p)}finally{r.delete(p.id)}}),createProxy(e,r,[],t)}function throwIfProxyReleased(e){if(e)throw new Error("Proxy has been released and is not useable")}function releaseEndpoint(e){return requestResponseMessage(e,new Map,{type:"RELEASE"}).then(()=>{closeEndPoint(e)})}const proxyCounter=new WeakMap,proxyFinalizers="FinalizationRegistry"in globalThis&&new FinalizationRegistry(e=>{const t=(proxyCounter.get(e)||0)-1;proxyCounter.set(e,t),t===0&&releaseEndpoint(e)});function registerProxy(e,t){const r=(proxyCounter.get(t)||0)+1;proxyCounter.set(t,r),proxyFinalizers&&proxyFinalizers.register(e,t,e)}function unregisterProxy(e){proxyFinalizers&&proxyFinalizers.unregister(e)}function createProxy(e,t,r=[],s=function(){}){let o=!1;const p=new Proxy(s,{get(f,w){if(throwIfProxyReleased(o),w===releaseProxy)return()=>{unregisterProxy(p),releaseEndpoint(e),t.clear(),o=!0};if(w==="then"){if(r.length===0)return{then:()=>p};const u=requestResponseMessage(e,t,{type:"GET",path:r.map(c=>c.toString())}).then(fromWireValue);return u.then.bind(u)}return createProxy(e,t,[...r,w])},set(f,w,u){throwIfProxyReleased(o);const[c,l]=toWireValue(u);return requestResponseMessage(e,t,{type:"SET",path:[...r,w].map(E=>E.toString()),value:c},l).then(fromWireValue)},apply(f,w,u){throwIfProxyReleased(o);const c=r[r.length-1];if(c===createEndpoint)return requestResponseMessage(e,t,{type:"ENDPOINT"}).then(fromWireValue);if(c==="bind")return createProxy(e,t,r.slice(0,-1));const[l,E]=processArguments(u);return requestResponseMessage(e,t,{type:"APPLY",path:r.map(m=>m.toString()),argumentList:l},E).then(fromWireValue)},construct(f,w){throwIfProxyReleased(o);const[u,c]=processArguments(w);return requestResponseMessage(e,t,{type:"CONSTRUCT",path:r.map(l=>l.toString()),argumentList:u},c).then(fromWireValue)}});return registerProxy(p,e),p}function myFlat(e){return Array.prototype.concat.apply([],e)}function processArguments(e){const t=e.map(toWireValue);return[t.map(r=>r[0]),myFlat(t.map(r=>r[1]))]}const transferCache=new WeakMap;function transfer(e,t){return transferCache.set(e,t),e}function proxy(e){return Object.assign(e,{[proxyMarker]:!0})}function windowEndpoint(e,t=globalThis,r="*"){return{postMessage:(s,o)=>e.postMessage(s,r,o),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function toWireValue(e){for(const[t,r]of transferHandlers)if(r.canHandle(e)){const[s,o]=r.serialize(e);return[{type:"HANDLER",name:t,value:s},o]}return[{type:"RAW",value:e},transferCache.get(e)||[]]}function fromWireValue(e){switch(e.type){case"HANDLER":return transferHandlers.get(e.name).deserialize(e.value);case"RAW":return e.value}}function requestResponseMessage(e,t,r,s){return new Promise(o=>{const p=generateUUID();t.set(p,o),e.start&&e.start(),e.postMessage(Object.assign({id:p},r),s)})}function generateUUID(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var comlink=Object.freeze({__proto__:null,createEndpoint,expose,finalizer,proxy,proxyMarker,releaseProxy,transfer,transferHandlers,windowEndpoint,wrap}),BackendEventType=(e=>(e.Start="start",e.End="end",e.Input="input",e.Output="output",e.Sleep="sleep",e.Error="error",e.Interrupt="interrupt",e.Loading="loading",e.Frame="frame",e.FrameChange="frame-change",e.Stop="stop",e))(BackendEventType||{});function getAugmentedNamespace(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if(typeof t=="function"){var r=function s(){var o=!1;try{o=this instanceof s}catch{}return o?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(s){var o=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(r,s,o.get?o:{enumerable:!0,get:function(){return e[s]}})}),r}var dist$1={exports:{}},dist={exports:{}},hasRequiredDist$1;function requireDist$1(){return hasRequiredDist$1||(hasRequiredDist$1=1,(function(e,t){(function(r,s){e.exports=s()})(self,(function(){return(()=>{var r={d:(n,i)=>{for(var a in i)r.o(i,a)&&!r.o(n,a)&&Object.defineProperty(n,a,{enumerable:!0,get:i[a]})},o:(n,i)=>Object.prototype.hasOwnProperty.call(n,i),r:n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})}},s={};r.r(s),r.d(s,{isServiceWorkerRequest:()=>w,serviceWorkerFetchListener:()=>u,asyncSleep:()=>c,ServiceWorkerError:()=>l,writeMessageAtomics:()=>E,writeMessageServiceWorker:()=>m,writeMessage:()=>_,makeChannel:()=>I,makeAtomicsChannel:()=>R,makeServiceWorkerChannel:()=>M,readMessage:()=>v,syncSleep:()=>O,uuidv4:()=>T});var o=function(n,i,a,d){return new(a||(a=Promise))((function(y,h){function x(b){try{k(d.next(b))}catch(P){h(P)}}function S(b){try{k(d.throw(b))}catch(P){h(P)}}function k(b){var P;b.done?y(b.value):(P=b.value,P instanceof a?P:new a((function(q){q(P)}))).then(x,S)}k((d=d.apply(n,[])).next())}))};const p="__SyncMessageServiceWorkerInput__",f="__sync-message-v2__";function w(n){return typeof n!="string"&&(n=n.request.url),n.includes(p)}function u(){const n={},i={};return a=>{const{url:d}=a.request;return!!w(d)&&(a.respondWith((function(){return o(this,void 0,void 0,(function*(){function y(h){const x={message:h,version:f};return new Response(JSON.stringify(x),{status:200})}if(d.endsWith("/read")){const{messageId:h,timeout:x}=yield a.request.json();if(h in n){const S=n[h];return delete n[h],y(S)}return yield new Promise((S=>{i[h]=S,setTimeout((function(){delete i[h],S(new Response("",{status:408}))}),x)}))}if(d.endsWith("/write")){const{message:h,messageId:x}=yield a.request.json(),S=i[x];return S?(S(y(h)),delete i[x]):n[x]=h,y({early:!S})}if(d.endsWith("/version"))return new Response(f,{status:200})}))})()),!0)}}function c(n){return new Promise((i=>setTimeout(i,n)))}class l extends Error{constructor(i,a){super(`Received status ${a} from ${i}. Ensure the service worker is registered and active.`),this.url=i,this.status=a,this.type="ServiceWorkerError",Object.setPrototypeOf(this,l.prototype)}}function E(n,i){const a=new TextEncoder().encode(JSON.stringify(i)),{data:d,meta:y}=n;if(a.length>d.length)throw new Error("Message is too big, increase bufferSize when making channel.");d.set(a,0),Atomics.store(y,0,a.length),Atomics.store(y,1,1),Atomics.notify(y,1)}function m(n,i,a){return o(this,void 0,void 0,(function*(){yield navigator.serviceWorker.ready;const d=n.baseUrl+"/write",y=Date.now();for(;;){const h={message:i,messageId:a},x=yield fetch(d,{method:"POST",body:JSON.stringify(h)});if(x.status===200&&(yield x.json()).version===f)return;if(!(Date.now()-y<n.timeout))throw new l(d,x.status);yield c(100)}}))}function _(n,i,a){return o(this,void 0,void 0,(function*(){n.type==="atomics"?E(n,i):yield m(n,i,a)}))}function I(n={}){return typeof SharedArrayBuffer<"u"?R(n.atomics):"serviceWorker"in navigator?M(n.serviceWorker):null}function R({bufferSize:n}={}){return{type:"atomics",data:new Uint8Array(new SharedArrayBuffer(n||131072)),meta:new Int32Array(new SharedArrayBuffer(2*Int32Array.BYTES_PER_ELEMENT))}}function M(n={}){return{type:"serviceWorker",baseUrl:(n.scope||"/")+p,timeout:n.timeout||5e3}}function g(n,i){return n>0?+n:i}function v(n,i,{checkInterrupt:a,checkTimeout:d,timeout:y}={}){const h=performance.now();d=g(d,a?100:5e3);const x=g(y,Number.POSITIVE_INFINITY);let S;if(n.type==="atomics"){const{data:k,meta:b}=n;S=()=>{if(Atomics.wait(b,1,0,d)==="timed-out")return null;{const P=Atomics.exchange(b,0,0),q=k.slice(0,P);Atomics.store(b,1,0);const C=new TextDecoder().decode(q);return JSON.parse(C)}}}else S=()=>{const k=new XMLHttpRequest,b=n.baseUrl+"/read";k.open("POST",b,!1);const P={messageId:i,timeout:d};k.send(JSON.stringify(P));const{status:q}=k;if(q===408)return null;if(q===200){const C=JSON.parse(k.responseText);return C.version!==f?null:C.message}if(performance.now()-h<n.timeout)return null;throw new l(b,q)};for(;;){const k=x-(performance.now()-h);if(k<=0)return null;d=Math.min(d,k);const b=S();if(b!==null)return b;if(a?.())return null}}function O(n,i){if(n=g(n,0))if(typeof SharedArrayBuffer<"u"){const a=new Int32Array(new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT));a[0]=0,Atomics.wait(a,0,0,n)}else v(i,`sleep ${n} ${T()}`,{timeout:n})}let T;return T="randomUUID"in crypto?function(){return crypto.randomUUID()}:function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(n=>{const i=Number(n);return(i^crypto.getRandomValues(new Uint8Array(1))[0]&15>>i/4).toString(16)}))},s})()}))})(dist)),dist.exports}var require$$1=getAugmentedNamespace(comlink),hasRequiredDist;function requireDist(){return hasRequiredDist||(hasRequiredDist=1,(function(e,t){(function(r,s){e.exports=s(requireDist$1(),require$$1)})(self,(function(r,s){return(()=>{var o={272:u=>{u.exports=s},746:u=>{u.exports=r}},p={};function f(u){var c=p[u];if(c!==void 0)return c.exports;var l=p[u]={exports:{}};return o[u](l,l.exports,f),l.exports}f.n=u=>{var c=u&&u.__esModule?()=>u.default:()=>u;return f.d(c,{a:c}),c},f.d=(u,c)=>{for(var l in c)f.o(c,l)&&!f.o(u,l)&&Object.defineProperty(u,l,{enumerable:!0,get:c[l]})},f.o=(u,c)=>Object.prototype.hasOwnProperty.call(u,c),f.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})};var w={};return(()=>{f.r(w),f.d(w,{InterruptError:()=>E,NoChannelError:()=>m,SyncClient:()=>_,syncExpose:()=>I});var u=f(746),c=f(272),l=function(M,g,v,O){return new(v||(v=Promise))((function(T,n){function i(y){try{d(O.next(y))}catch(h){n(h)}}function a(y){try{d(O.throw(y))}catch(h){n(h)}}function d(y){var h;y.done?T(y.value):(h=y.value,h instanceof v?h:new v((function(x){x(h)}))).then(i,a)}d((O=O.apply(M,[])).next())}))};class E extends Error{constructor(){super(...arguments),this.type="InterruptError",this.name=this.type}}class m extends Error{constructor(){super(...arguments),this.type="NoChannelError",this.name=this.type}}class _{constructor(g,v){this.workerCreator=g,this.channel=v,this.state="idle",this._messageIdBase="",this._messageIdSeq=0,this._start()}interrupt(){return l(this,void 0,void 0,(function*(){this.state!=="idle"&&(this.state!=="awaitingMessage"&&this.state!=="sleeping"?this.interrupter?yield this.interrupter():(this.terminate(),this._start()):yield this._writeMessage({interrupted:!0}))}))}call(g,...v){return l(this,void 0,void 0,(function*(){if(this.state!=="idle")throw new Error(`State is ${this.state}, not idle`);let O=!0;this.state="running",this._messageIdBase=(0,u.uuidv4)(),this._messageIdSeq=0;const T=n=>{var i;O&&n!=="init"&&(n==="reading"?(this.state="awaitingMessage",this._messageIdSeq++,(i=this._awaitingMessageResolve)===null||i===void 0||i.call(this)):n==="sleeping"?(this.state="sleeping",this._messageIdSeq++):n==="slept"&&(this.state="running"))};this._interruptPromise=new Promise(((n,i)=>this._interruptRejector=i));try{return yield Promise.race([g(this.channel,c.proxy(T),this._messageIdBase,...v),this._interruptPromise])}finally{O=!1,this._reset()}}))}writeMessage(g){return l(this,void 0,void 0,(function*(){if(this.state==="idle"||!this._messageIdBase)throw new Error("No active call to send a message to.");if(this.state!=="awaitingMessage"){if(this._awaitingMessageResolve)throw new Error("Not waiting for message, and another write is already queued.");yield new Promise((v=>{this._awaitingMessageResolve=v})),delete this._awaitingMessageResolve}yield this._writeMessage({message:g})}))}terminate(){var g;(g=this._interruptRejector)===null||g===void 0||g.call(this,new E("Worker terminated")),this.workerProxy[c.releaseProxy](),this.worker.terminate(),delete this.workerProxy,delete this.worker}_writeMessage(g){return l(this,void 0,void 0,(function*(){this.state="running";const v=R(this._messageIdBase,this._messageIdSeq);yield(0,u.writeMessage)(this.channel,g,v)}))}_start(){this._reset(),this.worker=this.workerCreator(),this.workerProxy=c.wrap(this.worker)}_reset(){this.state="idle",delete this._interruptPromise,delete this._interruptRejector,delete this._awaitingMessageResolve,delete this._messageIdBase}}function I(M){return function(g,v,O,...T){return l(this,void 0,void 0,(function*(){yield v("init");let n=0;function i(a,d){if(!g)throw new m;v(a);const y=R(O,++n),h=(0,u.readMessage)(g,y,d);if(h){const{message:x,interrupted:S}=h;if(S)throw new E;return x}a==="sleeping"&&v("slept")}return M({channel:g,readMessage:()=>i("reading"),syncSleep(a){a>0&&i("sleeping",{timeout:a})}},...T)}))}}function R(M,g){return`${M}-${g}`}})(),w})()}))})(dist$1)),dist$1.exports}var distExports=requireDist();class BackendEventQueue{constructor(t,r,s=1e3,o=100){this.callback=t,this.limit=s,this.flushTime=o,this.queue=[],this.overflow=[],this.onOverflow=r,this.overflown=!1,this.lastFlushTime=new Date().getTime(),this.sendCount=0,this.decoder=new TextDecoder}put(t,r,s){let o="";typeof r=="number"?o=r.toString():typeof r!="string"?o=this.decoder.decode(r):o=r;let p={},f="text/plain";s&&(typeof s=="string"?f=s:(f=s.contentType,delete s.contentType,p=s)),this.queue.length===0||!f.startsWith("text")||this.queue[this.queue.length-1].type!==t||this.queue[this.queue.length-1].contentType!==f?this.queue.push({type:t,data:o,contentType:f,...p}):this.queue[this.queue.length-1].data+=o,this.shouldFlush()&&this.flush()}shouldFlush(){return this.queue.length>1||new Date().getTime()-this.lastFlushTime>this.flushTime}reset(){this.queue=[],this.overflow=[],this.overflown=!1,this.lastFlushTime=new Date().getTime(),this.sendCount=0}static lines(t){return(t.data.match(/\n/g)||[]).length+1}flush(){this.queue.forEach(t=>{t.type===BackendEventType.Output?(this.overflow.push(t),this.sendCount<this.limit?(this.sendCount+=BackendEventQueue.lines(t),this.callback(t)):this.overflown||(this.overflown=!0,this.onOverflow())):this.callback(t)}),this.queue=[],this.lastFlushTime=new Date().getTime()}hasOverflow(){return this.overflown}getOverflow(){return this.overflow}setCallback(t){this.callback=t}}class Backend{constructor(){this.extras={},this.onEvent=()=>{},this.runCode=this.syncExpose()(this.runCode.bind(this)),this.queue={}}syncExpose(){return distExports.syncExpose}async launch(t,r){return this.onEvent=s=>{if(t(s),s.type===BackendEventType.Sleep)return this.extras.syncSleep(s.data);if(s.type===BackendEventType.Input)return this.extras.readMessage()},this.queue=new BackendEventQueue(this.onEvent.bind(this),r),Promise.resolve()}runModes(t){return[]}hasOverflow(){return this.queue.hasOverflow()}getOverflow(){return this.queue.getOverflow()}provideFiles(t,r){return Promise.resolve()}}class JavaScriptWorker extends Backend{static stringify(...e){return e.map(r=>{if(Array.isArray(r))return JSON.stringify(r);if(typeof r=="string")return r;if(typeof r=="number")return r+"";if(typeof r=="object"&&"toString"in r){let s=r.toString();return s==="[object Object]"&&(s=JSON.stringify(r)),s}else return JSON.stringify(e)}).join(" ")}prompt(e=""){return this.onEvent({type:BackendEventType.Input,data:e,contentType:"text/plain"})}consoleLog(...e){this.queue.put(BackendEventType.Output,JavaScriptWorker.stringify(...e)+`
`,"text/plain")}consoleError(...e){this.queue.put(BackendEventType.Error,JavaScriptWorker.stringify(...e)+`
`,"text/plain")}static completeProperties(e,t){const r=Object.keys(t).map(s=>({label:s,type:typeof t[s]=="function"?"function":"variable"}));return{from:e,options:r,validFor:/^[\w$]*$/}}async runCode(extras,code){this.extras=extras,this.queue.reset();const oldContent={"console.log":console.log,"console.error":console.error},newContext={prompt:this.prompt.bind(this),"console.log":this.consoleLog.bind(this),"console.error":this.consoleError.bind(this)};new Function("ctx",Object.keys(newContext).map(e=>`${e} = ctx['${e}'];`).join(`
`))(newContext);let result=null;try{this.onEvent({type:BackendEventType.Start,contentType:"text/plain",data:"RunCode"}),result=await eval(code)}catch(e){Error.captureStackTrace(e),result=await this.onEvent({type:BackendEventType.Error,contentType:"application/json",data:{name:e.constructor.name,what:e.message,traceback:e.stack}})}finally{new Function("ctx",Object.keys(oldContent).map(e=>`${e} = ctx['${e}'];`).join(`
`))(oldContent),this.queue.flush(),this.onEvent({type:BackendEventType.End,contentType:"text/plain",data:"CodeFinished"})}return result}async lintCode(){return Promise.resolve([])}}const worker=new JavaScriptWorker;expose(worker);
